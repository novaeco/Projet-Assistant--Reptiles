name: ESP-IDF Build and Test

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget flex bison gperf python3 python3-pip cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

    - name: Set up ESP-IDF
      run: |
        export ESP_IDF_PATH="$HOME/esp/esp-idf"
        git clone --recursive https://github.com/espressif/esp-idf.git $ESP_IDF_PATH
        . $ESP_IDF_PATH/export.sh

    # Correction: installer l'environnement Python d'ESP-IDF
    - name: Set up ESP-IDF Python environment
      run: |
        export ESP_IDF_PATH="$HOME/esp/esp-idf"
        . $ESP_IDF_PATH/export.sh
        $ESP_IDF_PATH/tools/idf_tools.py install-python-env
        source ~/.espressif/python_env/idf6.0_py3.12_env/bin/activate

    - name: Install ESP-IDF Python requirements
      run: |
        export ESP_IDF_PATH="$HOME/esp/esp-idf"
        pip install -r $ESP_IDF_PATH/requirements.txt

    - name: Build project
      run: |
        export ESP_IDF_PATH="$HOME/esp/esp-idf"
        . $ESP_IDF_PATH/export.sh
        idf.py build

    - name: Run tests
      run: |
        export ESP_IDF_PATH="$HOME/esp/esp-idf"
        . $ESP_IDF_PATH/export.sh
        idf.py test

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/
